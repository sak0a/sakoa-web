name: Deploy to Plesk

on:
  push:
    branches: [ main, master ]  # Deploy when pushing to main/master branch
  workflow_dispatch:  # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build project
      run: npm run generate
      env:
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        DB_NAME: ${{ secrets.DB_NAME }}
        ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
        
    - name: Deploy to Plesk via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PLESK_HOST }}
        username: ${{ secrets.PLESK_USERNAME }}
        password: ${{ secrets.PLESK_PASSWORD }}
        # Alternative: use key instead of password
        # key: ${{ secrets.PLESK_SSH_KEY }}
        script: |
          # Navigate to your domain's directory
          cd /var/www/vhosts/sakoa.xyz/httpdocs
          
          # Backup current deployment (optional)
          if [ -d "backup" ]; then rm -rf backup; fi
          mkdir backup
          cp -r * backup/ 2>/dev/null || true
          
          # Clear current files (except backup)
          find . -maxdepth 1 -not -name 'backup' -not -name '.' -not -name '..' -exec rm -rf {} +
          
    - name: Upload built files
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.PLESK_HOST }}
        username: ${{ secrets.PLESK_USERNAME }}
        password: ${{ secrets.PLESK_PASSWORD }}
        # Alternative: use key instead of password
        # key: ${{ secrets.PLESK_SSH_KEY }}
        source: ".output/public/*"
        target: "/var/www/vhosts/sakoa.xyz/httpdocs"
        strip_components: 2  # Remove .output/public/ from path
        
    - name: Set file permissions
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PLESK_HOST }}
        username: ${{ secrets.PLESK_USERNAME }}
        password: ${{ secrets.PLESK_PASSWORD }}
        script: |
          cd /var/www/vhosts/sakoa.xyz/httpdocs
          find . -type f -exec chmod 644 {} \;
          find . -type d -exec chmod 755 {} \;
          
    - name: Deployment notification
      run: |
        echo "üöÄ Deployment completed successfully!"
        echo "üåê Site should be live at: https://sakoa.xyz"
