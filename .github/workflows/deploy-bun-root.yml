name: Deploy to Ubuntu Root Server (Bun)

on:
  push:
    branches: [ main, master ]  # Deploy when pushing to main/master branch
  workflow_dispatch:  # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
        
    - name: Install dependencies
      run: bun install
      
    - name: Build project
      run: bun run build
      env:
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        DB_NAME: ${{ secrets.DB_NAME }}
        ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
        STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
        HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
        
    - name: Stop application service
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ROOT_SERVER_HOST }}
        username: ${{ secrets.ROOT_SERVER_USER }}
        password: ${{ secrets.ROOT_SERVER_PASSWORD }}
        script: |
          echo "🛑 Stopping dodgeball application service..."
          # Try to stop service - if user has sudo access, use it; otherwise skip
          if sudo -n systemctl stop dodgeball-app 2>/dev/null; then
            echo "✅ Service stopped successfully"
          else
            echo "⚠️ Could not stop service (may require manual stop or service not running)"
          fi

    - name: Backup and prepare deployment directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ROOT_SERVER_HOST }}
        username: ${{ secrets.ROOT_SERVER_USER }}
        password: ${{ secrets.ROOT_SERVER_PASSWORD }}
        script: |
          echo "💾 Preparing deployment directory..."

          # Create deployment directory if it doesn't exist
          mkdir -p /home/dodgeball-user/app

          # Create backup if previous deployment exists
          if [ -d "/home/dodgeball-user/app/.output" ] || [ -d "/home/dodgeball-user/app/server" ]; then
            echo "📦 Creating backup of current deployment..."
            rm -rf /home/dodgeball-user/app-backup 2>/dev/null || true
            cp -r /home/dodgeball-user/app /home/dodgeball-user/app-backup 2>/dev/null || true
            echo "✅ Backup created successfully"
          else
            echo "ℹ️ No existing deployment to backup"
          fi

          # Clear current deployment files
          echo "🧹 Clearing current deployment files..."
          rm -rf /home/dodgeball-user/app/.output /home/dodgeball-user/app/server 2>/dev/null || true
          echo "✅ Deployment directory prepared"
          
    - name: Upload built files
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.ROOT_SERVER_HOST }}
        username: ${{ secrets.ROOT_SERVER_USER }}
        password: ${{ secrets.ROOT_SERVER_PASSWORD }}
        source: ".output/*,server/*"
        target: "/home/dodgeball-user/app"
        strip_components: 0
        
    - name: Set file ownership and permissions
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ROOT_SERVER_HOST }}
        username: ${{ secrets.ROOT_SERVER_USER }}
        password: ${{ secrets.ROOT_SERVER_PASSWORD }}
        script: |
          echo "🔐 Setting file ownership and permissions..."

          # Try to set ownership if we have sudo access
          if sudo -n chown -R dodgeball-user:dodgeball-user /home/dodgeball-user/app 2>/dev/null; then
            echo "✅ File ownership set to dodgeball-user"
          else
            echo "⚠️ Could not change ownership (files owned by current user)"
          fi

          # Set file permissions
          cd /home/dodgeball-user/app
          find .output -type f -exec chmod 644 {} \; 2>/dev/null || true
          find .output -type d -exec chmod 755 {} \; 2>/dev/null || true
          find server -type f -exec chmod 644 {} \; 2>/dev/null || true
          find server -type d -exec chmod 755 {} \; 2>/dev/null || true
          chmod +x .output/server/index.mjs 2>/dev/null || true
          echo "✅ File permissions set successfully"
          
    - name: Create environment file
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ROOT_SERVER_HOST }}
        username: ${{ secrets.ROOT_SERVER_USER }}
        password: ${{ secrets.ROOT_SERVER_PASSWORD }}
        script: |
          echo "📝 Creating environment configuration..."
          cd /home/dodgeball-user/app/.output/server
          cat > .env << 'EOF'
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          STEAM_API_KEY=${{ secrets.STEAM_API_KEY }}
          HUGGINGFACE_API_KEY=${{ secrets.HUGGINGFACE_API_KEY }}
          PORT=3000
          HOST=127.0.0.1
          EOF
          chmod 600 .env
          echo "✅ Environment file created successfully"
          
    - name: Install Bun dependencies on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ROOT_SERVER_HOST }}
        username: ${{ secrets.ROOT_SERVER_USER }}
        password: ${{ secrets.ROOT_SERVER_PASSWORD }}
        script: |
          echo "📦 Installing Bun dependencies on server..."
          cd /home/dodgeball-user/app/.output/server

          # Try to use dodgeball-user's Bun installation, fallback to system Bun
          if [ -f "/home/dodgeball-user/.bun/bin/bun" ]; then
            /home/dodgeball-user/.bun/bin/bun install --production 2>/dev/null || echo "No package.json found or dependencies already satisfied"
          elif command -v bun >/dev/null 2>&1; then
            bun install --production 2>/dev/null || echo "No package.json found or dependencies already satisfied"
          else
            echo "⚠️ Bun not found, skipping dependency installation"
          fi
          echo "✅ Server dependencies ready"
          
    - name: Start application service
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ROOT_SERVER_HOST }}
        username: ${{ secrets.ROOT_SERVER_USER }}
        password: ${{ secrets.ROOT_SERVER_PASSWORD }}
        script: |
          echo "🚀 Starting dodgeball application service..."

          # First, let's check if the service file exists and is valid
          if sudo -n systemctl cat dodgeball-app >/dev/null 2>&1; then
            echo "✅ Service file found"
          else
            echo "❌ Service file not found or invalid"
            echo "Please create /etc/systemd/system/dodgeball-app.service"
            exit 1
          fi

          # Try to start and enable service with sudo
          if sudo -n systemctl start dodgeball-app 2>/dev/null; then
            echo "✅ Service start command executed"
            sudo -n systemctl enable dodgeball-app 2>/dev/null || echo "⚠️ Could not enable service"

            # Wait longer for service to stabilize
            echo "⏳ Waiting for service to stabilize..."
            sleep 10

            # Check service status with detailed output
            echo "🔍 Checking service status..."
            if sudo -n systemctl is-active --quiet dodgeball-app 2>/dev/null; then
              echo "✅ Application service is running"
              sudo -n systemctl status dodgeball-app --no-pager -l 2>/dev/null || echo "Status check completed"
            else
              echo "❌ Application service is not active"
              echo "📋 Service status:"
              sudo -n systemctl status dodgeball-app --no-pager -l 2>/dev/null || echo "Could not get detailed status"
              echo "📋 Recent logs:"
              sudo -n journalctl -u dodgeball-app --no-pager -l -n 30 2>/dev/null || echo "Could not get logs"
              echo "📋 Application files check:"
              ls -la /home/dodgeball-user/app/.output/server/ 2>/dev/null || echo "Could not list app files"
              echo "📋 Environment file check:"
              ls -la /home/dodgeball-user/app/.output/server/.env 2>/dev/null || echo "Environment file not found"
              echo "⚠️ Service failed to stay running - continuing deployment for manual debugging"
            fi
          else
            echo "⚠️ Could not start service automatically - manual restart required"
            echo "Please manually start the service: sudo systemctl start dodgeball-app"
          fi
          
    - name: Verify deployment and debug
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ROOT_SERVER_HOST }}
        username: ${{ secrets.ROOT_SERVER_USER }}
        password: ${{ secrets.ROOT_SERVER_PASSWORD }}
        script: |
          echo "🔍 Verifying deployment and gathering debug info..."

          # Check deployment files
          echo "📁 Checking deployment files:"
          ls -la /home/dodgeball-user/app/ 2>/dev/null || echo "App directory not found"
          ls -la /home/dodgeball-user/app/.output/ 2>/dev/null || echo ".output directory not found"
          ls -la /home/dodgeball-user/app/.output/server/ 2>/dev/null || echo "Server directory not found"

          # Check if main application file exists
          if [ -f "/home/dodgeball-user/app/.output/server/index.mjs" ]; then
            echo "✅ Main application file exists"
            ls -la /home/dodgeball-user/app/.output/server/index.mjs
          else
            echo "❌ Main application file missing"
          fi

          # Check environment file
          if [ -f "/home/dodgeball-user/app/.output/server/.env" ]; then
            echo "✅ Environment file exists"
            echo "📋 Environment file permissions:"
            ls -la /home/dodgeball-user/app/.output/server/.env
          else
            echo "❌ Environment file missing"
          fi

          # Check if application is responding
          echo "🌐 Testing application response:"
          if curl -f -s http://127.0.0.1:3000 > /dev/null; then
            echo "✅ Application is responding on port 3000"
          else
            echo "❌ Application is not responding on port 3000"
            echo "📋 Trying to start application manually for testing:"
            cd /home/dodgeball-user/app/.output/server
            timeout 10s /home/dodgeball-user/.bun/bin/bun run index.mjs 2>&1 || echo "Manual start failed or timed out"
          fi

          # Check nginx status
          if sudo -n systemctl is-active --quiet nginx 2>/dev/null; then
            echo "✅ Nginx is running"
          else
            echo "❌ Nginx is not running"
            sudo -n systemctl status nginx --no-pager 2>/dev/null || echo "Could not get nginx status"
          fi

          # Final service status check
          echo "🔧 Final service status:"
          sudo -n systemctl status dodgeball-app --no-pager -l 2>/dev/null || echo "Could not get service status"

          # Test external access (if domain is configured)
          echo "🌐 Testing external access..."
          curl -I -s https://sakoa.xyz || echo "External access test failed (may be normal during initial setup)"
          
    - name: Deployment notification
      run: |
        echo "🚀 Deployment completed successfully!"
        echo "🌐 Site should be available at: https://sakoa.xyz"
        echo "🔧 Server: Ubuntu 24 with Bun runtime"
        echo "👤 User: dodgeball-user"
        echo "🔄 Service: dodgeball-app (systemd)"
